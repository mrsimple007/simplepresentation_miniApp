<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Simple Slides</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body{margin:0;padding:0;overflow-x:hidden;-webkit-tap-highlight-color:transparent;transition:background-color .3s;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
        body.dark{background:#0a0a0a;color:#fff}
        body.light{background:#f5f5f5;color:#1a1a1a}
        .gradient-bg{background:linear-gradient(135deg,#6366f1 0%,#8b5cf6 50%,#ec4899 100%)}
        .card-hover{transition:all .3s cubic-bezier(.4,0,.2,1)}
        .card-hover:active{transform:scale(.98)}
        .slide-in{animation:slideIn .5s cubic-bezier(.4,0,.2,1)}
        @keyframes slideIn{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
        .glass-dark{background:rgba(255,255,255,.05);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.1)}
        .glass-light{background:rgba(255,255,255,.9);backdrop-filter:blur(10px);border:1px solid rgba(0,0,0,.1);box-shadow:0 4px 6px rgba(0,0,0,.1)}
        input[type="range"]{-webkit-appearance:none;appearance:none;background:rgba(99,102,241,.2);border-radius:10px;height:8px;width:100%}
        input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;background:#6366f1;border-radius:50%;cursor:pointer;box-shadow:0 0 10px rgba(99,102,241,.5)}
        input[type="range"]::-moz-range-thumb{width:20px;height:20px;background:#6366f1;border-radius:50%;cursor:pointer;border:none}
        textarea:focus,input:focus{outline:none}
        .style-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
        @media(min-width:640px){.style-grid{grid-template-columns:repeat(3,1fr)}}
        .success-anim{animation:successPulse .5s ease-in-out}
        @keyframes successPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
        .lang-menu{position:fixed;top:60px;right:20px;background:rgba(0,0,0,.95);border-radius:12px;padding:8px;z-index:1000;min-width:140px;box-shadow:0 4px 12px rgba(0,0,0,.3)}
        .lang-menu.light{background:rgba(255,255,255,.98);box-shadow:0 4px 12px rgba(0,0,0,.2)}
        .lang-item{padding:10px 16px;cursor:pointer;border-radius:8px;transition:all .2s;display:flex;align-items:center;gap:8px}
        .lang-item:hover{background:rgba(99,102,241,.2)}
        .lang-item.active{background:rgba(99,102,241,.3)}
        .hamburger{cursor:pointer;padding:8px;display:flex;flex-direction:column;gap:4px;border-radius:8px;transition:all .3s}
        .hamburger span{width:20px;height:2px;background:currentColor;border-radius:2px;transition:all .3s}
        .style-preview{width:100%;border-radius:12px;margin-bottom:16px;box-shadow:0 4px 8px rgba(0,0,0,.2)}
        .pagination{display:flex;justify-content:center;gap:12px;margin-top:16px}
        .page-btn{padding:8px 16px;border-radius:8px;font-weight:600;transition:all .3s;cursor:pointer}
    </style>
</head>
<body class="dark">
    <div id="app"></div>
    <script>
let tg=window.Telegram?.WebApp;
if(tg){tg.ready();tg.expand()}

// State management
let step='home',user={balance:0,created:0,lang:'uz',theme:'dark',name:'',id:''},form={content:'',slides:8,style:'formal',language:'auto',type:'presentation',pages:10,author:'',university:''},showLang=false,stylePage=1,isSending=false;

const TYPES={presentation:{id:'presentation',name:{uz:'üìä Taqdimot',ru:'üìä –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è',en:'üìä Presentation'},min:1,max:21,def:8,isPres:true},referat:{id:'referat',name:{uz:'üìö Referat',ru:'üìö –†–µ—Ñ–µ—Ä–∞—Ç',en:'üìö Referat'},min:1,max:25,def:12},mustaqil:{id:'mustaqil',name:{uz:'‚úçÔ∏è Mustaqil ish',ru:'‚úçÔ∏è –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞',en:'‚úçÔ∏è Independent Work'},min:1,max:15,def:6},kurs:{id:'kurs',name:{uz:'üéì Kurs ishi',ru:'üéì –ö—É—Ä—Å–æ–≤–∞—è —Ä–∞–±–æ—Ç–∞',en:'üéì Course Work'},min:25,max:35,def:30},maqola:{id:'maqola',name:{uz:'üì∞ Maqola',ru:'üì∞ –°—Ç–∞—Ç—å—è',en:'üì∞ Article'},min:5,max:10,def:8},tezis:{id:'tezis',name:{uz:'üìã Tezis',ru:'üìã –¢–µ–∑–∏—Å—ã',en:'üìã Thesis'},min:1,max:2,def:1},insho:{id:'insho',name:{uz:'‚úèÔ∏è Insho',ru:'‚úèÔ∏è –≠—Å—Å–µ',en:'‚úèÔ∏è Essay'},min:1,max:3,def:2},resume:{id:'resume',name:{uz:'üë§ Rezyume',ru:'üë§ –†–µ–∑—é–º–µ',en:'üë§ Resume'},isRes:true}};

const T={uz:{title:'Simple Slides',subtitle:'AI kuchi bilan yarating',balance:'Balans',created:'Yaratilgan',docs:'hujjat',userId:'ID',createPresentation:'Taqdimot',createReferat:'Referat',createMustaqil:'Mustaqil ish',createKurs:'Kurs ishi',createMaqola:'Maqola',createTezis:'Tezis',createInsho:'Insho',createResume:'Rezyume',back:'Orqaga',contentLabel:'Mazmun yoki mavzu',contentPlaceholder:'Mavzuni kiriting...',slidesLabel:'Slaydlar soni',pagesLabel:'Sahifalar soni',languageLabel:'Til',styleLabel:'Stil',authorLabel:'Muallif',authorPlaceholder:'Ismingizni kiriting',universityLabel:'Universitet',universityPlaceholder:'Universitet nomini kiriting',continueToBot:'Botda davom etish',sendingToBot:'Botga yuborilmoqda',successSent:'Yuborildi!',closingIn:'Yopilmoqda',enterContent:'Mazmun kiriting!',insufficientBalance:'Balans yetarli emas',topUpBalance:'Balansni to\'ldirish',auto:'Avtomatik',uzbek:'O\'zbek',russian:'Rus',english:'Ingliz',selectStyle:'Stilni tanlang',prev:'Oldingi',next:'Keyingi'},ru:{title:'Simple Slides',subtitle:'–°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Å AI',balance:'–ë–∞–ª–∞–Ω—Å',created:'–°–æ–∑–¥–∞–Ω–æ',docs:'–¥–æ–∫.',userId:'ID',createPresentation:'–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è',createReferat:'–†–µ—Ñ–µ—Ä–∞—Ç',createMustaqil:'–°–∞–º–æ—Å—Ç. —Ä–∞–±–æ—Ç–∞',createKurs:'–ö—É—Ä—Å–æ–≤–∞—è',createMaqola:'–°—Ç–∞—Ç—å—è',createTezis:'–¢–µ–∑–∏—Å—ã',createInsho:'–≠—Å—Å–µ',createResume:'–†–µ–∑—é–º–µ',back:'–ù–∞–∑–∞–¥',contentLabel:'–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∏–ª–∏ —Ç–µ–º–∞',contentPlaceholder:'–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É...',slidesLabel:'–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–∞–π–¥–æ–≤',pagesLabel:'–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü',languageLabel:'–Ø–∑—ã–∫',styleLabel:'–°—Ç–∏–ª—å',authorLabel:'–ê–≤—Ç–æ—Ä',authorPlaceholder:'–í–∞—à–µ –∏–º—è',universityLabel:'–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç',universityPlaceholder:'–ù–∞–∑–≤–∞–Ω–∏–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞',continueToBot:'–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤ –±–æ—Ç–µ',sendingToBot:'–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –±–æ—Ç',successSent:'–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!',closingIn:'–ó–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑',enterContent:'–í–≤–µ–¥–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ!',insufficientBalance:'–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤',topUpBalance:'–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å',auto:'–ê–≤—Ç–æ',uzbek:'–£–∑–±–µ–∫—Å–∫–∏–π',russian:'–†—É—Å—Å–∫–∏–π',english:'–ê–Ω–≥–ª–∏–π—Å–∫–∏–π',selectStyle:'–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å',prev:'–ù–∞–∑–∞–¥',next:'–î–∞–ª–µ–µ'},en:{title:'Simple Slides',subtitle:'Create with AI',balance:'Balance',created:'Created',docs:'docs',userId:'ID',createPresentation:'Presentation',createReferat:'Referat',createMustaqil:'Independent Work',createKurs:'Course Work',createMaqola:'Article',createTezis:'Thesis',createInsho:'Essay',createResume:'Resume',back:'Back',contentLabel:'Content or Topic',contentPlaceholder:'Enter topic...',slidesLabel:'Number of Slides',pagesLabel:'Number of Pages',languageLabel:'Language',styleLabel:'Style',authorLabel:'Author',authorPlaceholder:'Your name',universityLabel:'University',universityPlaceholder:'University name',continueToBot:'Continue to Bot',sendingToBot:'Sending to bot',successSent:'Sent!',closingIn:'Closing in',enterContent:'Enter content!',insufficientBalance:'Insufficient balance',topUpBalance:'Top Up Balance',auto:'Auto',uzbek:'Uzbek',russian:'Russian',english:'English',selectStyle:'Select Style',prev:'Previous',next:'Next'}};

const STYLES_P1=[{id:'formal',name:'üìö Formal'},{id:'creative',name:'üé® Creative'},{id:'casual',name:'üòä Casual'},{id:'academic',name:'üéì Academic'},{id:'style_win_1',name:'üèÜ Win 1'},{id:'style_win_2',name:'ü•á Win 2'},{id:'style_1',name:'1'},{id:'style_2',name:'2'},{id:'style_3',name:'3'},{id:'style_4',name:'4'},{id:'style_5',name:'5'},{id:'style_6',name:'6'}];
const STYLES_P2=[{id:'style_7',name:'7'},{id:'style_8',name:'8'},{id:'style_9',name:'9'},{id:'style_10',name:'10'},{id:'style_11',name:'11'},{id:'style_12',name:'12'},{id:'style_13',name:'13'},{id:'style_14',name:'14'}];
const RSTYLES=[{id:'classic',name:'Classic'},{id:'modern',name:'Modern'},{id:'tech',name:'Tech'}];
const STYLE_IMG_1='https://enygxibkgjoqjmqsiwdi.supabase.co/storage/v1/object/sign/pptbackground/back_images/1st_overall.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xMDBjOGJkMC02NTRhLTQxNTMtYWQ5Zi1kNmNlMzU3YjMzZGYiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJwcHRiYWNrZ3JvdW5kL2JhY2tfaW1hZ2VzLzFzdF9vdmVyYWxsLnBuZyIsImlhdCI6MTc2NTUzNzYwMSwiZXhwIjoxNzk3MDczNjAxfQ.U-VQdYLilFdLUJmV76V3ZYCNhobA1AVcdLRLa7LRUT4';
const STYLE_IMG_2='https://enygxibkgjoqjmqsiwdi.supabase.co/storage/v1/object/sign/pptbackground/back_images/2nd_overall_back_images.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xMDBjOGJkMC02NTRhLTQxNTMtYWQ5Zi1kNmNlMzU3YjMzZGYiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJwcHRiYWNrZ3JvdW5kL2JhY2tfaW1hZ2VzLzJuZF9vdmVyYWxsX2JhY2tfaW1hZ2VzLnBuZyIsImlhdCI6MTc2MzYzNzIyMSwiZXhwIjoxNzk1MTczMjIxfQ.wYx3Q7_ZYXh00ut-otgqRN4Ksdzu_rECMpmaiOy1ggg';

function getData(){
    const u=tg?.initDataUnsafe?.user;
    if(u){
        user.balance=15000;
        user.created=24;
        user.lang=u.language_code==='ru'?'ru':u.language_code==='en'?'en':'uz';
        user.name=u.first_name+(u.last_name?' '+u.last_name:'');
        user.id=u.id;
        console.log('User data loaded:', user);
    }else{
        user.name='Test User';
        user.id='123456789';
        user.balance=15000;
        user.created=24;
        console.log('Test mode - no Telegram data');
    }
}

function t(k){return T[user.lang][k]||T['uz'][k]}
function toggleTheme(){user.theme=user.theme==='dark'?'light':'dark';document.body.className=user.theme;render()}
function toggleLang(){showLang=!showLang;render()}
function changeLang(l){user.lang=l;showLang=false;render()}
function theme(){return user.theme==='dark'?{bg:'bg-gradient-to-br from-gray-950 via-gray-900 to-gray-950',txt:'text-white',sec:'text-white/70',glass:'glass-dark',inp:'bg-gray-900/50 border-gray-700 text-white placeholder-gray-500',card:'bg-gray-800/50 text-gray-300'}:{bg:'bg-gradient-to-br from-gray-50 via-white to-gray-100',txt:'text-gray-900',sec:'text-gray-600',glass:'glass-light',inp:'bg-white border-gray-300 text-gray-900 placeholder-gray-400',card:'bg-white text-gray-700'}}

function render(){
    const a=document.getElementById('app'),th=theme();
    if(step==='home')renderHome(a,th);
    else if(step==='create')renderForm(a,th);
    else if(step==='sending')renderSend(a,th);
}

function renderHome(a,th){
    a.innerHTML=`<div class="min-h-screen ${th.bg} slide-in"><div class="gradient-bg p-6 rounded-b-3xl shadow-2xl relative"><div class="max-w-2xl mx-auto"><div class="flex items-center justify-between mb-4"><div><h1 class="text-2xl font-bold">${t('title')}</h1><p class="text-white/70 text-sm">${t('subtitle')}</p></div><div class="flex items-center space-x-2"><div onclick="toggleLang()" class="hamburger text-white"><span></span><span></span><span></span></div><button onclick="toggleTheme()" class="w-10 h-10 ${th.glass} rounded-full flex items-center justify-center text-xl">${user.theme==='dark'?'‚òÄÔ∏è':'üåô'}</button></div></div><div class="${th.glass} rounded-2xl p-4 mb-3"><div class="text-white/60 text-xs mb-1">üë§ ${user.name}</div><div class="text-sm font-medium">${t('userId')}: ${user.id}</div></div><div class="grid grid-cols-2 gap-3"><div class="${th.glass} rounded-2xl p-4"><div class="text-white/60 text-xs mb-1">${t('balance')}</div><div class="text-xl font-bold">${user.balance.toLocaleString()} UZS</div></div><div class="${th.glass} rounded-2xl p-4"><div class="text-white/60 text-xs mb-1">${t('created')}</div><div class="text-xl font-bold">${user.created} ${t('docs')}</div></div></div></div>${showLang?`<div class="lang-menu ${user.theme==='light'?'light':''}"><div onclick="changeLang('uz')" class="lang-item ${user.lang==='uz'?'active':''} ${th.txt}"><span>üá∫üáø</span><span>${t('uzbek')}</span></div><div onclick="changeLang('ru')" class="lang-item ${user.lang==='ru'?'active':''} ${th.txt}"><span>üá∑üá∫</span><span>${t('russian')}</span></div><div onclick="changeLang('en')" class="lang-item ${user.lang==='en'?'active':''} ${th.txt}"><span>üá¨üáß</span><span>${t('english')}</span></div></div>`:''}</div><div class="max-w-2xl mx-auto p-6"><div class="grid grid-cols-2 gap-3 mb-3"><button onclick="startCreate('presentation')" class="gradient-bg text-white rounded-2xl p-5 shadow-xl card-hover"><div class="text-3xl mb-2">üìä</div><div class="font-semibold text-sm">${t('createPresentation')}</div></button><button onclick="startCreate('referat')" class="${th.glass} rounded-2xl p-5 card-hover ${th.txt}"><div class="text-3xl mb-2">üìö</div><div class="font-semibold text-sm">${t('createReferat')}</div></button></div><div class="grid grid-cols-2 gap-3 mb-3"><button onclick="startCreate('mustaqil')" class="${th.glass} rounded-2xl p-5 card-hover ${th.txt}"><div class="text-3xl mb-2">‚úçÔ∏è</div><div class="font-semibold text-sm">${t('createMustaqil')}</div></button><button onclick="startCreate('kurs')" class="${th.glass} rounded-2xl p-5 card-hover ${th.txt}"><div class="text-3xl mb-2">üéì</div><div class="font-semibold text-sm">${t('createKurs')}</div></button></div><div class="grid grid-cols-2 gap-3 mb-3"><button onclick="startCreate('maqola')" class="${th.glass} rounded-2xl p-5 card-hover ${th.txt}"><div class="text-3xl mb-2">üì∞</div><div class="font-semibold text-sm">${t('createMaqola')}</div></button><button onclick="startCreate('tezis')" class="${th.glass} rounded-2xl p-5 card-hover ${th.txt}"><div class="text-3xl mb-2">üìã</div><div class="font-semibold text-sm">${t('createTezis')}</div></button></div><div class="grid grid-cols-2 gap-3"><button onclick="startCreate('insho')" class="${th.glass} rounded-2xl p-5 card-hover ${th.txt}"><div class="text-3xl mb-2">‚úèÔ∏è</div><div class="font-semibold text-sm">${t('createInsho')}</div></button><button onclick="startCreate('resume')" class="gradient-bg text-white rounded-2xl p-5 shadow-xl card-hover"><div class="text-3xl mb-2">üë§</div><div class="font-semibold text-sm">${t('createResume')}</div></button></div></div></div>`;
}

function renderForm(a,th){
    const dt=TYPES[form.type],isPres=dt.isPres,isRes=dt.isRes,isDoc=!isPres&&!isRes,styles=isPres?(stylePage===1?STYLES_P1:STYLES_P2):isRes?RSTYLES:[],minP=dt.min||1,maxP=dt.max||30;
    if(!form.pages||form.pages<minP||form.pages>maxP)form.pages=isPres?form.slides:dt.def;
    const styleImg=isPres?(stylePage===1?STYLE_IMG_1:STYLE_IMG_2):'';
    
    a.innerHTML=`<div class="min-h-screen ${th.bg} slide-in"><div class="max-w-2xl mx-auto p-6"><button onclick="goHome()" class="mb-6 text-indigo-400 font-medium flex items-center space-x-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg><span>${t('back')}</span></button><div class="${th.glass} rounded-3xl p-6 mb-6"><h2 class="text-2xl font-bold ${th.txt}">${dt.name[user.lang]}</h2></div><div class="space-y-5"><div class="${th.glass} rounded-2xl p-5"><label class="block text-sm font-medium ${th.sec} mb-3">${t('contentLabel')}</label><textarea id="content-input" placeholder="${t('contentPlaceholder')}" class="w-full h-40 px-4 py-3 ${th.inp} border rounded-xl resize-none">${form.content}</textarea></div>${isDoc?`<div class="${th.glass} rounded-2xl p-5"><label class="block text-sm font-medium ${th.sec} mb-3">${t('authorLabel')}</label><input type="text" id="author-input" placeholder="${t('authorPlaceholder')}" value="${form.author}" class="w-full px-4 py-3 ${th.inp} border rounded-xl"></div><div class="${th.glass} rounded-2xl p-5"><label class="block text-sm font-medium ${th.sec} mb-3">${t('universityLabel')}</label><input type="text" id="university-input" placeholder="${t('universityPlaceholder')}" value="${form.university}" class="w-full px-4 py-3 ${th.inp} border rounded-xl"></div>`:''}${isPres?`<div class="${th.glass} rounded-2xl p-5"><label class="block text-sm font-medium ${th.sec} mb-4">${t('slidesLabel')}: <span id="pages-value" class="text-indigo-400 font-bold">${form.pages}</span></label><input type="range" id="pages-input" min="${minP}" max="${maxP}" value="${form.pages}" class="w-full cursor-pointer"><div class="flex justify-between text-xs ${th.sec} mt-3"><span>${minP}</span><span>${maxP}</span></div></div>`:!isRes?`<div class="${th.glass} rounded-2xl p-5"><label class="block text-sm font-medium ${th.sec} mb-4">${t('pagesLabel')}: <span id="pages-value" class="text-indigo-400 font-bold">${form.pages}</span></label><input type="range" id="pages-input" min="${minP}" max="${maxP}" value="${form.pages}" class="w-full cursor-pointer"><div class="flex justify-between text-xs ${th.sec} mt-3"><span>${minP}</span><span>${maxP}</span></div></div>`:''}<div class="${th.glass} rounded-2xl p-5"><label class="block text-sm font-medium ${th.sec} mb-3">${t('languageLabel')}</label><div class="grid grid-cols-2 gap-3">${[{c:'auto',l:'ü§ñ '+t('auto')},{c:'uz',l:'üá∫üáø '+t('uzbek')},{c:'ru',l:'üá∑üá∫ '+t('russian')},{c:'en',l:'üá¨üáß '+t('english')}].map(lg=>`<button onclick="selectLang('${lg.c}')" class="px-4 py-3 rounded-xl font-medium ${form.language===lg.c?'bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg':th.card+' hover:opacity-80'}">${lg.l}</button>`).join('')}</div></div>${isPres||isRes?`<div class="${th.glass} rounded-2xl p-5"><label class="block text-sm font-medium ${th.sec} mb-3">${t('selectStyle')}</label>${isPres&&styleImg?`<img src="${styleImg}" alt="Style Preview" class="style-preview">`:''}${isPres?`<div class="pagination"><button onclick="prevStylePage()" class="page-btn ${stylePage===1?'opacity-50 cursor-not-allowed':th.card+' hover:opacity-80'}" ${stylePage===1?'disabled':''}>${t('prev')}</button><span class="${th.txt} font-bold">${stylePage}/2</span><button onclick="nextStylePage()" class="page-btn ${stylePage===2?'opacity-50 cursor-not-allowed':th.card+' hover:opacity-80'}" ${stylePage===2?'disabled':''}>${t('next')}</button></div>`:''}<div class="${isPres?'style-grid mt-4':'space-y-3'}">${styles.map(s=>`<button onclick="selectStyle('${s.id}')" class="${isPres?'px-3 py-3 rounded-xl font-medium text-center':'w-full px-4 py-3 rounded-xl font-medium text-left'} ${form.style===s.id?'bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg':th.card+' hover:opacity-80'}">${s.name}</button>`).join('')}</div></div>`:''}<button onclick="validate()" class="w-full gradient-bg text-white rounded-2xl py-4 font-bold shadow-2xl card-hover flex items-center justify-center space-x-3" ${isSending?'disabled':''}><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg><span>${isSending?t('sendingToBot'):t('continueToBot')}</span></button></div></div></div>`;
    
    setTimeout(()=>{
        const ci=document.getElementById('content-input');
        if(ci)ci.addEventListener('input',e=>form.content=e.target.value);
        const ai=document.getElementById('author-input');
        if(ai)ai.addEventListener('input',e=>form.author=e.target.value);
        const ui=document.getElementById('university-input');
        if(ui)ui.addEventListener('input',e=>form.university=e.target.value);
        const pi=document.getElementById('pages-input');
        if(pi)pi.addEventListener('input',e=>{
            form.pages=parseInt(e.target.value);
            if(isPres)form.slides=form.pages;
            document.getElementById('pages-value').textContent=form.pages;
        });
    },100);
}

function renderSend(a,th){
    a.innerHTML=`<div class="min-h-screen ${th.bg} flex items-center justify-center slide-in"><div class="text-center px-6"><div class="success-anim mb-6"><div class="w-24 h-24 mx-auto bg-green-500 rounded-full flex items-center justify-center shadow-lg"><svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div></div><h2 class="text-2xl font-bold mb-2 ${th.txt}">${t('successSent')}</h2><p class="${th.sec} mb-6">${t('closingIn')} <span id="timer" class="font-bold">5</span> s</p></div></div>`;
    
    let c=5;
    const tm=document.getElementById('timer'),iv=setInterval(()=>{
        c--;
        if(tm)tm.textContent=c;
        if(c<=0){
            clearInterval(iv);
            if(tg&&tg.close){
                tg.close();
            }
        }
    },1000);
}

function startCreate(type){
    form.type=type;
    const dt=TYPES[type];
    if(dt.isPres){
        form.pages=dt.def;
        form.slides=dt.def;
    }else if(dt.isRes){
        form.pages=1;
    }else{
        form.pages=dt.def;
    }
    form.content='';
    form.style=dt.isPres?'formal':dt.isRes?'classic':'';
    form.language='auto';
    form.author='';
    form.university='';
    stylePage=1;
    isSending=false;
    step='create';
    render();
}

function goHome(){
    step='home';
    isSending=false;
    render();
}

function selectLang(l){
    form.language=l;
    render();
}

function selectStyle(s){
    form.style=s;
    render();
}

function prevStylePage(){
    if(stylePage>1){
        stylePage--;
        render();
    }
}

function nextStylePage(){
    if(stylePage<2){
        stylePage++;
        render();
    }
}

function validate(){
    // Prevent double submission
    if(isSending){
        console.log('Already sending, ignoring...');
        return;
    }
    
    if(!form.content.trim()){
        alert(t('enterContent'));
        return;
    }
    
    const cost=calcCost();
    if(user.balance<cost){
        if(confirm(t('insufficientBalance')+'. '+t('topUpBalance')+'?')){
            window.open('https://t.me/YourTopUpBot','_blank');
        }
        return;
    }
    
    // Set sending state
    isSending=true;
    step='sending';
    render();
    
    const dataToSend={
        action:'create_presentation',
        content:form.content,
        slides:form.slides||form.pages,
        style:form.style,
        language:form.language,
        type:form.type,
        pages:form.pages,
        author:form.author||'',
        university:form.university||''
    };
    
    try{
        if(tg && tg.sendData){
            console.log('Sending data to bot:',dataToSend);
            tg.sendData(JSON.stringify(dataToSend));
            console.log('Data sent successfully');
        }else{
            console.error('Telegram WebApp not available');
            alert('Error: Please open this from Telegram');
            isSending=false;
            goHome();
        }
    }catch(error){
        console.error('Error sending data:',error);
        alert('Error sending data. Please try again.');
        isSending=false;
        goHome();
    }
}

function calcCost(){
    const dt=TYPES[form.type];
    let base=0;
    if(dt.isPres){
        base=form.slides*500;
    }else if(dt.isRes){
        base=3000;
    }else{
        base=form.pages*400;
    }
    return base;
}

window.onload=()=>{
    getData();
    render();
};

document.addEventListener('click',e=>{
    if(!e.target.closest('.hamburger')&&!e.target.closest('.lang-menu')){
        if(showLang){
            showLang=false;
            render();
        }
    }
});
    </script>
</body>
</html>